
PROC IMPORT DATAFILE = "C:\Users\Think\Desktop\data.xlsx" OUT = case_origin DBMS = Excel REPLACE;
run;     
data case;set case_origin;run;
 
data case;                                                                                                                              
set case;                                                                                                                               
if maturity=01 then maturitydate="24jan2018"d;                                                                                          
if maturity=02 then maturitydate="28feb2018"d;                                                                                          
if maturity=03 then maturitydate="28mar2018"d;                                                                                          
if maturity=04 then maturitydate="25apr2018"d;                                                                                          
if maturity=05 then maturitydate="23may2018"d;                                                                                          
if maturity=06 then maturitydate="27jun2018"d;                                                                                          
if maturity=07 then maturitydate="25jul2018"d;                                                                                          
if maturity=08 then maturitydate="22aug2018"d;                                                                                          
if maturity=09 then maturitydate="26sep2018"d;                                                                                          
if maturity=10 then maturitydate="24oct2018"d;                                                                                          
if maturity=11 then maturitydate="28nov2018"d;                                                                                          
if maturity=12 then maturitydate="26dec2018"d;                                                                                          
t=(maturitydate-date)/365;                                                                                                                    
drop code tradecode;                                                                                                                    
run;                                                                                                                                    
                                                                                                                                        
data call; set case; if type="call" ; c=price; drop type price;             
data put;  set case; if type="put" ; p=price;drop type price;run;                                                                                                                                    
proc sort data=call; by date maturity strike;                                                                                                                
proc sort data=put;by date maturity strike;  run;                                                                                                                                    
data merged;merge call put; by date maturity strike; run;                                                                                                                                    
proc sort data=merged nodupkey out=keep; by date;run;                                                                                                                                    
data keep; set keep;  obs=_n_;  run;                                                                                                                                    
data merged;  merge merged keep;   by date;  diff=abs(c-p);  run;  




%macro skew(num=);
%do i=1 %to &num;
data data&i; set merged;maturity=month(maturitydate);if obs=&i;if maturitydate-date<7 then delete;run; 
data a;set data&i;run;
proc sort data=a nodupkey;by maturity; 
data b(keep= date month);set a(firstobs=1 obs=1);month=maturity;run;
data data&i;merge data&i b;by date;if maturity=month;run;
proc sort data=data&i; by diff; run;                                                                                                                                    
data min(keep=date k op oc) ; set data&i(firstobs=1 obs=1); k=strike; oc=c;op=p; run;                                                                                                                                    
                                                                                                                                        
data data&i;                                                                                                                             
merge data&i min;                                                                                                                        
by date;                                                                                                                                
if strike<k then price=p;                                                                                                               
else if strike>k then price=c;                                                                                                          
else price=(c+p)/2;
f=exp(rf*t)*(oc-op)+k;
run;  
data data&i;
set data&i;
e1=-(1+log(k/f)-f/k);
e2=2*log(k/f)*(f/k-1)+0.5*(log(k/f))**2;
e3=3*(log(k/f))**2*(1/3*log(k/f)-1+f/k);
run;
proc sort data=data&i;
by date strike;
run;
data data&i;
set data&i;
lag1=lag1(strike);
lag2=lag2(strike);
run; 
proc sort data=data&i;
by date strike;
run;
data temp;
set data&i(firstobs=2);
by date strike;
delta=0.5*(strike-lag2);
if first.date then delta=strike-lag1;
run;
data temp;
set temp;
drop strike;
run;
data temp(keep=strike delta);
set temp;
strike=lag1;
run;
proc sort data=data&i; by strike;
proc sort data=temp; by strike; run;
data data&i; merge data&i temp; by strike; run;
data data&i; set data&i; by date; if last.date then delta=strike-lag1; run;
data data&i(drop=maturity lag1 lag2 maturitydate); set data&i; 
s1=price*delta/(strike**2);
s2=2*(1-log(strike/f))*price*delta/(strike**2);
s3=3*(2*log(strike/f)-(log(strike/f))**2)*price*delta/(strike**2£©;
run;
proc univariate data=data&i noprint;
var s1 s2 s3;
output out=sum
sum= sum1 sum2 sum3;
run;
data sum; set sum; temp=1;
data data&i; set data&i; temp=1; run;
data data&i; merge data&i sum; by temp;run;
data data&i;set data&i; 
p1=(exp(rf*t))*(-sum1)+e1;
p2=(exp(rf*t))*sum2+e2;
p3=(exp(rf*t))*sum3+e3;
snear=(p3-3*p1*p2+2*p1**3)/(p2-p1**2)**(3/2);
run;
proc univariate data=data&i noprint;
var date snear t;
output out=snear
mean= date snear tnear;
run;


data data&i; set merged;maturity=month(maturitydate);if obs=&i;if maturitydate-date<7 then delete;run; 
data a;set data&i;run;
proc sort data=a nodupkey;by maturity; run;
data b(keep= date month);set a(firstobs=2 obs=2);month=maturity;run;
data data&i;merge data&i b;by date;if maturity=month;run;
proc sort data=data&i; by diff; run;                                                                                                                                    
data min(keep=date k op oc) ; set data&i(firstobs=1 obs=1); k=strike; oc=c;op=p; run;                                                                                                                                    
                                                                                                                                        
data data&i;                                                                                                                             
merge data&i min;                                                                                                                        
by date;                                                                                                                                
if strike<k then price=p;                                                                                                               
else if strike>k then price=c;                                                                                                          
else price=(c+p)/2;
f=exp(rf*t)*(oc-op)+k;
run;  
data data&i;
set data&i;
e1=-(1+log(k/f)-f/k);
e2=2*log(k/f)*(f/k-1)+0.5*(log(k/f))**2;
e3=3*(log(k/f))**2*(1/3*log(k/f)-1+f/k);
run;
proc sort data=data&i;
by date strike;
run;
data data&i;
set data&i;
lag1=lag1(strike);
lag2=lag2(strike);
run; 
proc sort data=data&i;
by date strike;
run;
data temp;
set data&i(firstobs=2);
by date strike;
delta=0.5*(strike-lag2);
if first.date then delta=strike-lag1;
run;
data temp;
set temp;
drop strike;
run;
data temp(keep=strike delta);
set temp;
strike=lag1;
run;
proc sort data=data&i; by strike;
proc sort data=temp; by strike; run;
data data&i; merge data&i temp; by strike; run;
data data&i; set data&i; by date; if last.date then delta=strike-lag1; run;
data data&i(drop=maturity lag1 lag2 maturitydate); set data&i; 
s1=price*delta/(strike**2);
s2=2*(1-log(strike/f))*price*delta/(strike**2);
s3=3*(2*log(strike/f)-(log(strike/f))**2)*price*delta/(strike**2£©;
run;
proc univariate data=data&i noprint;
var s1 s2 s3;
output out=sum
sum= sum1 sum2 sum3;
run;
data sum; set sum; temp=1;
data data&i; set data&i; temp=1; run;
data data&i; merge data&i sum; by temp;run;
data data&i;set data&i; 
p1=(exp(rf*t))*(-sum1)+e1;
p2=(exp(rf*t))*sum2+e2;
p3=(exp(rf*t))*sum3+e3;
snext=(p3-3*p1*p2+2*p1**3)/(p2-p1**2)**(3/2);
run;
proc univariate data=data&i noprint;
var date snext t;
output out=snext
mean= date snext tnext;
run;
data skew&i;
merge snear snext;
by date;
run;
data skew&i;
set skew&i;
format date mmddyy8.;
w=(tnext-30/365)/(tnext-tnear);
skew =100-10*(w*snear+(1-w)*snext);
drop snear snext tnear tnext w;
run;

proc append base=skew data=skew&i;
run;

%end;
%mend skew;
%skew(num=96);
